name: Notify Discord on New Blog Post

on:
  push:
    paths:
      - "_posts/**"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect new posts in commit
        id: detect
        run: |
          # Check if HEAD~1 exists; if not, use HEAD (first commit)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD~1 HEAD | grep '^_posts/' | head -n 1 || true)
          else
            FILES=$(git show --name-only HEAD | grep '^_posts/' | head -n 1 || true)
          fi
          echo "FILES=$FILES" >> $GITHUB_OUTPUT

      - name: Post to Discord (Message Components V2)
        if: steps.detect.outputs.FILES != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -x
          # Find the newest post file from this commit
          NEW_POST="${{ steps.detect.outputs.FILES }}"
          [ -z "$NEW_POST" ] && echo "No post file found" && exit 1
          
          TITLE=$(grep -m1 '^title:' "$NEW_POST" | sed 's/^title: *//' | sed 's/^"//' | sed 's/"$//')
          DESCRIPTION=$(grep -m1 '^description:' "$NEW_POST" | sed 's/^description: *//' | sed 's/^"//' | sed 's/"$//')
          
          # Build site URL from _config.yml values
          SITE_URL=$(grep -E '^url:' _config.yml | awk '{print $2}')
          BASEURL=$(grep -E '^baseurl:' _config.yml | awk '{print $2}')
          
          # Permalink structure: /blog/:title/
          FNAME=$(basename "$NEW_POST")
          SLUG=${FNAME#??????????-}  # strip YYYY-MM-DD-
          SLUG=${SLUG%.md}
          POST_PATH="/blog/${SLUG}/"
          URL="${SITE_URL}${BASEURL}${POST_PATH}"
          
          echo "TITLE=$TITLE"
          echo "DESCRIPTION=$DESCRIPTION"
          echo "URL=$URL"
          
          # Build Discord payload using jq for proper JSON encoding
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg description "$DESCRIPTION" \
            --arg url "$URL" \
            '{
              content: "ðŸ“¢ New blog post published!",
              embeds: [{
                title: $title,
                description: $description,
                url: $url,
                color: 5814783
              }],
              components: [{
                type: 1,
                components: [{
                  type: 2,
                  style: 5,
                  label: "Read on Site",
                  url: $url
                }]
              }]
            }')
          
          echo "Payload: $PAYLOAD"
          curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
